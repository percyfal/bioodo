# Copyright (C) 2015 by Per Unneberg
from blaze import DataFrame, odo
from bioodo import fastqc
import pytest
import re

@pytest.fixture(scope="module")
def fastqc_data(tmpdir_factory):
    fn = tmpdir_factory.mktemp('data').join('fastqc_data.txt')
    fn.write("""##FastQC	0.11.2
>>Basic Statistics	pass
#Measure	Value
Filename	s1_1.fastq.gz
File type	Conventional base calls
Encoding	Sanger / Illumina 1.9
Total Sequences	25
Sequences flagged as poor quality	0
Sequence length	76
%GC	48
>>END_MODULE
>>Per base sequence quality	fail
#Base	Mean	Median	Lower Quartile	Upper Quartile	10th Percentile	90th Percentile
1	30.68	0.0	0.0	0.0	0.0	0.0
2	32.4	0.0	0.0	0.0	0.0	0.0
3	33.0	0.0	0.0	0.0	0.0	0.0
4	33.96	0.0	0.0	0.0	0.0	0.0
5	34.08	0.0	0.0	0.0	0.0	0.0
6	34.28	0.0	0.0	0.0	0.0	0.0
7	34.44	0.0	0.0	0.0	0.0	0.0
8	34.28	0.0	0.0	0.0	0.0	0.0
9	34.12	0.0	0.0	0.0	0.0	0.0
10-11	34.14	0.0	0.0	0.0	0.0	0.0
12-13	33.88	0.0	0.0	0.0	0.0	0.0
14-15	35.120000000000005	0.0	0.0	0.0	0.0	0.0
16-17	33.540000000000006	0.0	0.0	0.0	0.0	0.0
18-19	34.92	0.0	0.0	0.0	0.0	0.0
20-21	33.1	0.0	0.0	0.0	0.0	0.0
22-23	34.06	0.0	0.0	0.0	0.0	0.0
24-25	33.42	0.0	0.0	0.0	0.0	0.0
26-27	33.879999999999995	0.0	0.0	0.0	0.0	0.0
28-29	33.7	0.0	0.0	0.0	0.0	0.0
30-31	33.46	0.0	0.0	0.0	0.0	0.0
32-33	32.96	0.0	0.0	0.0	0.0	0.0
34-35	33.620000000000005	0.0	0.0	0.0	0.0	0.0
36-37	33.84	0.0	0.0	0.0	0.0	0.0
38-39	32.9	0.0	0.0	0.0	0.0	0.0
40-41	32.72	0.0	0.0	0.0	0.0	0.0
42-43	33.06	0.0	0.0	0.0	0.0	0.0
44-45	32.74	0.0	0.0	0.0	0.0	0.0
46-47	33.08	0.0	0.0	0.0	0.0	0.0
48-49	32.3	0.0	0.0	0.0	0.0	0.0
50-51	32.24	0.0	0.0	0.0	0.0	0.0
52-53	33.519999999999996	0.0	0.0	0.0	0.0	0.0
54-55	32.56	0.0	0.0	0.0	0.0	0.0
56-57	32.94	0.0	0.0	0.0	0.0	0.0
58-59	31.1	0.0	0.0	0.0	0.0	0.0
60-61	32.019999999999996	0.0	0.0	0.0	0.0	0.0
62-63	30.880000000000003	0.0	0.0	0.0	0.0	0.0
64-65	29.759999999999998	0.0	0.0	0.0	0.0	0.0
66-67	30.22	0.0	0.0	0.0	0.0	0.0
68-69	30.46	0.0	0.0	0.0	0.0	0.0
70-71	29.5	0.0	0.0	0.0	0.0	0.0
72-73	26.58	0.0	0.0	0.0	0.0	0.0
74-75	25.119999999999997	0.0	0.0	0.0	0.0	0.0
76	22.48	0.0	0.0	0.0	0.0	0.0
>>END_MODULE
>>Per sequence quality scores	pass
#Quality	Count
9	1.0
10	0.0
11	0.0
12	0.0
13	0.0
14	0.0
15	0.0
16	0.0
17	0.0
18	0.0
19	0.0
20	0.0
21	1.0
22	0.0
23	0.0
24	0.0
25	0.0
26	0.0
27	2.0
28	0.0
29	0.0
30	2.0
31	2.0
32	3.0
33	0.0
34	1.0
35	10.0
36	3.0
>>END_MODULE
>>Per base sequence content	fail
#Base	G	A	T	C
1	32.0	20.0	32.0	16.0
2	24.0	20.0	24.0	32.0
3	32.0	32.0	24.0	12.0
4	16.0	28.000000000000004	24.0	32.0
5	24.0	24.0	28.000000000000004	24.0
6	44.0	28.000000000000004	20.0	8.0
7	28.000000000000004	24.0	12.0	36.0
8	16.0	24.0	28.000000000000004	32.0
9	24.0	20.0	20.0	36.0
10-11	26.0	30.0	18.0	26.0
12-13	20.0	32.0	26.0	22.0
14-15	38.0	20.0	22.0	20.0
16-17	16.0	40.0	16.0	28.000000000000004
18-19	30.0	28.000000000000004	20.0	22.0
20-21	26.0	28.000000000000004	20.0	26.0
22-23	36.0	32.0	14.000000000000002	18.0
24-25	30.0	26.0	20.0	24.0
26-27	30.0	24.0	26.0	20.0
28-29	26.0	26.0	26.0	22.0
30-31	22.0	22.0	24.0	32.0
32-33	20.0	24.0	30.0	26.0
34-35	34.0	24.0	24.0	18.0
36-37	20.0	24.0	22.0	34.0
38-39	24.489795918367346	26.53061224489796	30.612244897959183	18.367346938775512
40-41	18.0	30.0	22.0	30.0
42-43	22.0	32.0	16.0	30.0
44-45	22.0	34.0	20.0	24.0
46-47	18.0	24.0	32.0	26.0
48-49	20.0	36.0	16.0	28.000000000000004
50-51	22.0	30.0	30.0	18.0
52-53	16.0	28.000000000000004	22.0	34.0
54-55	32.0	26.0	28.000000000000004	14.000000000000002
56-57	22.0	28.000000000000004	16.0	34.0
58-59	22.0	30.0	30.0	18.0
60-61	28.000000000000004	20.0	26.0	26.0
62-63	16.3265306122449	32.6530612244898	26.53061224489796	24.489795918367346
64-65	22.0	22.0	30.0	26.0
66-67	20.0	24.0	32.0	24.0
68-69	28.000000000000004	22.0	36.0	14.000000000000002
70-71	26.0	32.0	20.0	22.0
72-73	26.0	32.0	18.0	24.0
74-75	30.0	26.0	26.0	18.0
76	20.0	12.0	36.0	32.0
>>END_MODULE
>>Per sequence GC content	fail
#GC Content	Count
0	0.0
1	0.0
2	0.0
3	0.0
4	0.0
5	0.0
6	0.0
7	0.0
8	0.0
9	0.0
10	0.0
11	0.0
12	0.0
13	0.0
14	0.0
15	0.0
16	0.0
17	0.0
18	0.0
19	0.0
20	0.0
21	0.0
22	0.0
23	0.0
24	0.0
25	0.0
26	0.0
27	0.0
28	0.0
29	0.0
30	0.0
31	0.0
32	0.0
33	0.0
34	0.0
35	0.5
36	1.0
37	1.0
38	0.5
39	0.0
40	0.5
41	1.5
42	2.0
43	1.0
44	0.5
45	0.5
46	0.0
47	1.0
48	3.5
49	5.0
50	5.0
51	3.0
52	1.0
53	1.0
54	1.0
55	0.5
56	0.5
57	1.5
58	2.0
59	1.0
60	0.0
61	0.5
62	1.0
63	0.5
64	0.0
65	0.0
66	0.0
67	0.0
68	0.0
69	0.0
70	0.0
71	0.0
72	0.0
73	0.0
74	0.0
75	0.0
76	0.0
77	0.0
78	0.0
79	0.0
80	0.0
81	0.0
82	0.0
83	0.0
84	0.0
85	0.0
86	0.0
87	0.0
88	0.0
89	0.0
90	0.0
91	0.0
92	0.0
93	0.0
94	0.0
95	0.0
96	0.0
97	0.0
98	0.0
99	0.0
100	0.0
>>END_MODULE
>>Per base N content	pass
#Base	N-Count
1	0.0
2	0.0
3	0.0
4	0.0
5	0.0
6	0.0
7	0.0
8	0.0
9	0.0
10-11	0.0
12-13	0.0
14-15	0.0
16-17	0.0
18-19	0.0
20-21	0.0
22-23	0.0
24-25	0.0
26-27	0.0
28-29	0.0
30-31	0.0
32-33	0.0
34-35	0.0
36-37	0.0
38-39	2.0
40-41	0.0
42-43	0.0
44-45	0.0
46-47	0.0
48-49	0.0
50-51	0.0
52-53	0.0
54-55	0.0
56-57	0.0
58-59	0.0
60-61	0.0
62-63	2.0
64-65	0.0
66-67	0.0
68-69	0.0
70-71	0.0
72-73	0.0
74-75	0.0
76	0.0
>>END_MODULE
>>Sequence Length Distribution	pass
#Length	Count
76	25.0
>>END_MODULE
>>Sequence Duplication Levels	pass
#Total Deduplicated Percentage	100.0
#Duplication Level	Percentage of deduplicated	Percentage of total
1	100.0	100.0
2	0.0	0.0
3	0.0	0.0
4	0.0	0.0
5	0.0	0.0
6	0.0	0.0
7	0.0	0.0
8	0.0	0.0
9	0.0	0.0
>10	0.0	0.0
>50	0.0	0.0
>100	0.0	0.0
>500	0.0	0.0
>1k	0.0	0.0
>5k	0.0	0.0
>10k+	0.0	0.0
>>END_MODULE
>>Overrepresented sequences	fail
#Sequence	Count	Percentage	Possible Source
ACAGCAGCAGCTCAGGATGATGGTGATGGTCCACGCCAGCCAGAACCACC	1	4.0	No Hit
GGGCTTCTGGATAGGCAGTCAGGTTGATTTCATGTTGCTACTGCTGGACT	1	4.0	No Hit
CTGAACCCCCACAGGATAAGGAAGCCTGTGTGTGTACCAACAATCAAAGC	1	4.0	No Hit
GTAACTACTACTATGAACATTGGTGGTTCTGGCTGGCGTGGACCATCACC	1	4.0	No Hit
AATCAAAGCTACATCTGTGACACAACAGGACACTGCTATGGGCAGTCTCA	1	4.0	No Hit
CCTCTAGGCACTGCCCAGCCCTGTGTCAGCCAGGGCTNAACCCCCACAAG	1	4.0	No Hit
TAAAGGACTCTTGAGCAATAAGAACAAAGCTGAAGGCCTCACAATCTGAC	1	4.0	No Hit
GCTCAGGATGATGGTGATGGTCCACGCCAGCCAGAACCACCAATGTTCAT	1	4.0	No Hit
TCCACGCCAGCCAGAACCACCAATGTTCATAGTAGTAGTTACAACACTGA	1	4.0	No Hit
GTGTGTACCAACAATCAAAGCTACATCTGTGACACAACAGGACACTGCTA	1	4.0	No Hit
ACTGCTATGGGCAGTCTCAGTGTTGTAACTACTACTATGAACATTGGTGG	1	4.0	No Hit
GCATTACCCTGATACCAAAACCAGAGAAGGACACTATAATAAAAATAAAT	1	4.0	No Hit
TGATGGTGATGGTCCACGCCAGCCAGAACCACCAATGTTCATAGTAGTAG	1	4.0	No Hit
GGCAGACACAGCAGCAGCTCAGGATGATGGTGATGGTCCACGCCAGCCAG	1	4.0	No Hit
ACATTGGTGGTTCTGGCTGGCGGGGGCCATCACCATCATCCTGAGCTGCT	1	4.0	No Hit
GTGATGGTCCACGCCAGCCAGAACCACCAATGTTCATAGTAGTAGTTATA	1	4.0	No Hit
GCTTTGATTGTTGGTACACACACAGGCTTCCTTATCCTGTGGGGGTTCAG	1	4.0	No Hit
CAGCAGCTCAGGATGATGGTGATGGTCCACGCCAGCCAGAACCACCAATG	1	4.0	No Hit
CAGCAGCAGCTCAGGATGATGGTGATGGTCCACGCCAGCCAGAACCACCA	1	4.0	No Hit
TTTGGTGAAATAAAATGGTAGCACTGAGTAATTGCGGGCTTCTGGATAGG	1	4.0	No Hit
TAGCAGTGTCCTGTTGTGTCACAGATGTAGCTTTGATTGTTGGTACACAC	1	4.0	No Hit
TGGTGGCAGACACAGCAGCAGCTCAGGATGATGGTGATGGTCCACGCCAG	1	4.0	No Hit
ATAGTAGTAGTTACAACACTGAGACTGCCCATAGCAGTGTCCTGTTGTGT	1	4.0	No Hit
TGCCCATAGCAGTGTCCTGTTGTGTCACAGATGTAGCTTTGATTGTTGGT	1	4.0	No Hit
TGAACCCCCACAGGATAAGGAAGCCTGTGTGTGTACCAACAATCAAAGCT	1	4.0	No Hit
>>END_MODULE
>>Adapter Content	pass
#Position	Illumina Universal Adapter	Illumina Small RNA Adapter	Nextera Transposase Sequence
1	0.0	0.0	0.0
2	0.0	0.0	0.0
3	0.0	0.0	0.0
4	0.0	0.0	0.0
5	0.0	0.0	0.0
6	0.0	0.0	0.0
7	0.0	0.0	0.0
8	0.0	0.0	0.0
9	0.0	0.0	0.0
10	0.0	0.0	0.0
11	0.0	0.0	0.0
12	0.0	0.0	0.0
13	0.0	0.0	0.0
14	0.0	0.0	0.0
15	0.0	0.0	0.0
16	0.0	0.0	0.0
17	0.0	0.0	0.0
18	0.0	0.0	0.0
19	0.0	0.0	0.0
20	0.0	0.0	0.0
21	0.0	0.0	0.0
22	0.0	0.0	0.0
23	0.0	0.0	0.0
24	0.0	0.0	0.0
25	0.0	0.0	0.0
26	0.0	0.0	0.0
27	0.0	0.0	0.0
28	0.0	0.0	0.0
29	0.0	0.0	0.0
30	0.0	0.0	0.0
31	0.0	0.0	0.0
32	0.0	0.0	0.0
33	0.0	0.0	0.0
34	0.0	0.0	0.0
35	0.0	0.0	0.0
36	0.0	0.0	0.0
37	0.0	0.0	0.0
38	0.0	0.0	0.0
39	0.0	0.0	0.0
40	0.0	0.0	0.0
41	0.0	0.0	0.0
42	0.0	0.0	0.0
43	0.0	0.0	0.0
44	0.0	0.0	0.0
45	0.0	0.0	0.0
46	0.0	0.0	0.0
47	0.0	0.0	0.0
48	0.0	0.0	0.0
49	0.0	0.0	0.0
50	0.0	0.0	0.0
51	0.0	0.0	0.0
52	0.0	0.0	0.0
53	0.0	0.0	0.0
54	0.0	0.0	0.0
55	0.0	0.0	0.0
56	0.0	0.0	0.0
57	0.0	0.0	0.0
58	0.0	0.0	0.0
59	0.0	0.0	0.0
60	0.0	0.0	0.0
61	0.0	0.0	0.0
62	0.0	0.0	0.0
63	0.0	0.0	0.0
64	0.0	0.0	0.0
>>END_MODULE
>>Kmer Content	pass
>>END_MODULE
""")
    return fn


def test_basic_statistics(fastqc_data):
    df = odo(str(fastqc_data), DataFrame)
    assert(list(df.index) == ['Filename', 'File type', 'Encoding', 'Total Sequences', 'Sequences flagged as poor quality', 'Sequence length', '%GC'])
    assert(df.loc["Filename", "Value"] == "s1_1.fastq.gz")


def test_summary(fastqc_data):
    df = odo(str(fastqc_data), DataFrame, key="Summary")
    assert(df.loc['Basic_Statistics', 'Value'] == "pass")


def test_wrong_key(fastqc_data):
    with pytest.raises(KeyError):
        df = odo(str(fastqc_data), DataFrame, key="foo")


def test_per_base_sequence_quality(fastqc_data):
    df = odo(str(fastqc_data),  DataFrame, key="Per_base_sequence_quality")
    assert df.shape[0] == 43
    assert df.shape[1] == 6

